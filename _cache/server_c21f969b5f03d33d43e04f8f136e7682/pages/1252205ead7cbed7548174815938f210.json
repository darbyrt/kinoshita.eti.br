{"content": {"content": [{"o": 134, "f": null, "c": "Having worked in Open Source for a few years, one of my favorite things is when you can\nshare experience with other people that you meet. [Andrew Gray](https://github.com/agray)\nhas worked with .NET and Jenkins for years, and we met through some Open Source. He also\nwrites the blog [Jenkins.NET](http://jenkinsheaven.blogspot.co.nz/).\n\nA couple of days ago he had an interesting question about using Active Choices Plug-in\nin Jenkins. He wanted to see if that would be possible to use the plug-in to show different\nparameters depending on the user permission.\n\nAnother important point is that it needed to support the\n[Role Strategy Plug-in](https://wiki.jenkins-ci.org/display/JENKINS/Role+Strategy+Plugin). This plug-in\nlets you define roles, define which permissions a role has, and then assign users to the roles.\n\n## To the code\n\n{% geshi 'groovy' %}\nimport hudson.model.User\nimport hudson.model.Hudson\nimport hudson.security.AuthorizationStrategy\nimport hudson.security.Permission\nimport com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy\nimport com.michelin.cio.hudson.plugins.rolestrategy.RoleMap\n\nAuthorizationStrategy strategy = Hudson.getInstance().getAuthorizationStrategy();\n\njobs = []\nuser = User.current()\nuserId = user.getId()\n\nif (strategy != null && strategy instanceof com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy) {\n    roleStrategy = (RoleBasedAuthorizationStrategy) strategy;\n    // not very straightforward to get the groups for a given user\n    roles = roleStrategy.getGrantedRoles(\"globalRoles\")\n    for (entry in roles) {\n        role = entry.key\n        users = entry.value\n        if (role.getName().equals(\"tester\")) {\n            if (userId in users) {\n                jobs = [\"PROJECT_FOR_TESTERS1\", \"PROJECT_FOR_TESTERS2\"]\n                break\n            }\n        } else if (role.getName().equals(\"admin\")) {\n            if (userId in users) {\n                jobs = [\"PROJECT_FOR_ADMINS1\", \"PROJECT_FOR_ADMINS2\"]\n                break\n            }\n        }\n    }\n}\n\nreturn jobs\n// TODO: handle anonymous user ;-)\n{% endgeshi %}\n\nLet's dissect the code.\n\n{% geshi 'groovy' %}\nimport hudson.model.User\nimport hudson.model.Hudson\nimport hudson.security.AuthorizationStrategy\nimport hudson.security.Permission\nimport com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy\nimport com.michelin.cio.hudson.plugins.rolestrategy.RoleMap\n{% endgeshi %}\n\nYou start by importing the classes that you need. If you are going to run the code against classes\nthat may exist only on slaves, you may have to write some more logic to import classes accordingly.\n\n{% geshi 'groovy' %}\nAuthorizationStrategy strategy = Hudson.getInstance().getAuthorizationStrategy();\n\njobs = []\nuser = User.current()\nuserId = user.getId()\n{% endgeshi %}\n\nThe first line gets the current [AuthorizationStrategy](https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/security/AuthorizationStrategy.java)\nused in Jenkins.\n\nThen we create an empty array of jobs, which is the value returned by default. And get the current\nlogged in user ID.\n\n{% geshi 'groovy' %}\nif (strategy != null && strategy instanceof com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy) {\n    roleStrategy = (RoleBasedAuthorizationStrategy) strategy;\n    // not very straightforward to get the groups for a given user\n    roles = roleStrategy.getGrantedRoles(\"globalRoles\")\n    for (entry in roles) {\n        role = entry.key\n        users = entry.value\n        if (role.getName().equals(\"tester\")) {\n            if (userId in users) {\n                jobs = [\"PROJECT_FOR_TESTERS1\", \"PROJECT_FOR_TESTERS2\"]\n                break\n            }\n        } else if (role.getName().equals(\"admin\")) {\n            if (userId in users) {\n                jobs = [\"PROJECT_FOR_ADMINS1\", \"PROJECT_FOR_ADMINS2\"]\n                break\n            }\n        }\n    }\n}\n\nreturn jobs\n// TODO: handle anonymous user ;-)\n{% endgeshi %}\n\nThe final part simply iterates through each existing role, and then through the\nusers in that role. I could not find a more ellegant way of doing that, but in case\nyou would like to maybe optimize the code, here are the main classes that I\nused from Jenkins to write the script.\n\n* [RoleBasedAuthorizationStrategy.java](https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleBasedAuthorizationStrategy.java)\n* [Role.java](https://github.com/jenkinsci/role-strategy-plugin/blob/master/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/Role.java)\n* [RoleMap](https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleMap.java)\n* [User.java](https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/model/User.java)\n\n## What the code does\n\nIn this section we have just simple screenshots, showing the script in the job configuration.\n\n<div class='row'>\n<div class=\"ui container\" style='text-align: center;'>\n<figure>\n<a href=\"{{assets.screenshot01}}\" rel=\"prettyPhoto\" class=\"thumbnail\" title=\"Screen shot 01\">\n<img class=\"ui fluid image\" src=\"{{assets.screenshot01}}\" alt=\"Screen shot 01\" />\n</a>\n<figcaption>Screen shot 01</figcaption>\n</figure>\n</div>\n</div>\n\nAnd the resulting screen. The parameter **DeployApp** will be available during the build,\nand can be used to trigger other jobs or pipelines.\n\n<div class='row'>\n<div class=\"ui container\" style='text-align: center;'>\n<figure>\n<a href=\"{{assets.screenshot02}}\" rel=\"prettyPhoto\" class=\"thumbnail\" title=\"Screen shot 02\">\n<img class=\"ui fluid image\" src=\"{{assets.screenshot02}}\" alt=\"Screen shot 02\" />\n</a>\n<figcaption>Screen shot 02</figcaption>\n</figure>\n</div>\n</div>\n\n## Where can you find this script?\n\nThis blog has a copy of the script, but in case you forget the address, I have submitted\na pull request to a [repository](https://github.com/imoutsatsos/jenkins-scriptlets)\nmaintained by another friend, [Ioannis Moutsatsos](https://github.com/imoutsatsos). Ioannis\nmaintains a Jenkins installation in Novartis, and is probably the most skillful user\nof the Active Choices Plug-in.\n\nAnother advantage of this other copy, is that it may be updated with time, in case there are\nbugs or improvements. So watch Ioannis' repository for updates!\n\nHappy hacking!\n\n", "l": 8}]}, "config": {"title": "Usgin Active Choices with Role Strategy Plug-in", "author": "kinow", "tags": ["jenkins"], "category": "blog", "time": "16:05:03", "format": null, "content_type": "html", "segments": ["content"]}}