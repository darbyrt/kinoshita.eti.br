{"segments": {"content": "<p><a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Credentials+Plugin\">Jenkins Credentials Plug-in</a> manages credentials stored in Jenkins. These credentials can be used in many jobs and by plug-ins for executing SSH commands, authenticating to systems, or running other commands that need some sort of authentication or authorisation.</p>\n<p>I recently used its API for the first time in the <a href=\"https://github.com/biouno/figshare-plugin\">BioUno figshare Plug-in</a> to store OAuth 1.0 credentials (consumer key, consumer secret, token key, token secret). This <a href=\"http://biouno.org/2015/09/05/using_jenkins_credentials_plugin_to_create_the_biouno_figshare_plugin/\">blog post</a> has more details about how we used the plug-in, but this post is specifically on how the passwords are stored by Jenkins.</p>\n<h2>Secret and ciphers</h2>\n<p>Jenkins stores its configuration on disk as XML using the XStream library. Plug-in developers using the Credentials Plug-in API must use the <strong>Secret</strong> class to encrypt sensitive information.</p>\n<p>The <code>Secret.fromString</code> method is responsible for creating a cipher from a given String. As in the Secret Javadoc,  <em>&#8220;this is not meant as a protection against code running in the same VM, nor against an attacker who has local file system access on Jenkins master&#8221;</em>. But at least makes things more complicated :-)</p>\n<ul>\n<li><a href=\"http://javadoc.jenkins-ci.org/hudson/util/Secret.html\">Secret Javadoc</a></li>\n<li><a href=\"https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/util/Secret.java\">Secret source code</a></li>\n</ul>\n<div class=\"highlight\"><pre><span class=\"kd\">public</span> <span class=\"kd\">static</span> <span class=\"n\">Secret</span> <span class=\"nf\">fromString</span><span class=\"o\">(</span><span class=\"n\">String</span> <span class=\"n\">data</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">Util</span><span class=\"o\">.</span><span class=\"na\">fixNull</span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"o\">);</span>\n    <span class=\"n\">Secret</span> <span class=\"n\">s</span> <span class=\"o\">=</span> <span class=\"n\">decrypt</span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"o\">);</span>\n    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">==</span><span class=\"kc\">null</span><span class=\"o\">)</span> <span class=\"n\">s</span><span class=\"o\">=</span><span class=\"k\">new</span> <span class=\"n\">Secret</span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"o\">);</span>\n    <span class=\"k\">return</span> <span class=\"n\">s</span><span class=\"o\">;</span>\n<span class=\"o\">}</span>\n</pre></div>\n\n<p>The first line simply replaces a null string by an empty &#8220;&#8221;, or keeps the current value of not null.</p>\n<p>After that, the decrypt method is called.</p>\n<div class=\"highlight\"><pre><span class=\"kd\">public</span> <span class=\"kd\">static</span> <span class=\"n\">Secret</span> <span class=\"nf\">decrypt</span><span class=\"o\">(</span><span class=\"n\">String</span> <span class=\"n\">data</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"o\">==</span><span class=\"kc\">null</span><span class=\"o\">)</span>      <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"k\">try</span> <span class=\"o\">{</span>\n        <span class=\"kt\">byte</span><span class=\"o\">[]</span> <span class=\"n\">in</span> <span class=\"o\">=</span> <span class=\"n\">Base64</span><span class=\"o\">.</span><span class=\"na\">decode</span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"na\">toCharArray</span><span class=\"o\">());</span>\n        <span class=\"n\">Secret</span> <span class=\"n\">s</span> <span class=\"o\">=</span> <span class=\"n\">tryDecrypt</span><span class=\"o\">(</span><span class=\"n\">KEY</span><span class=\"o\">.</span><span class=\"na\">decrypt</span><span class=\"o\">(),</span> <span class=\"n\">in</span><span class=\"o\">);</span>\n        <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">!=</span><span class=\"kc\">null</span><span class=\"o\">)</span>    <span class=\"k\">return</span> <span class=\"n\">s</span><span class=\"o\">;</span>\n\n        <span class=\"c1\">// try our historical key for backward compatibility</span>\n        <span class=\"n\">Cipher</span> <span class=\"n\">cipher</span> <span class=\"o\">=</span> <span class=\"n\">getCipher</span><span class=\"o\">(</span><span class=\"s\">&quot;AES&quot;</span><span class=\"o\">);</span>\n        <span class=\"n\">cipher</span><span class=\"o\">.</span><span class=\"na\">init</span><span class=\"o\">(</span><span class=\"n\">Cipher</span><span class=\"o\">.</span><span class=\"na\">DECRYPT_MODE</span><span class=\"o\">,</span> <span class=\"n\">getLegacyKey</span><span class=\"o\">());</span>\n        <span class=\"k\">return</span> <span class=\"n\">tryDecrypt</span><span class=\"o\">(</span><span class=\"n\">cipher</span><span class=\"o\">,</span> <span class=\"n\">in</span><span class=\"o\">);</span>\n    <span class=\"o\">}</span> <span class=\"k\">catch</span> <span class=\"o\">(</span><span class=\"n\">GeneralSecurityException</span> <span class=\"n\">e</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span> <span class=\"k\">catch</span> <span class=\"o\">(</span><span class=\"n\">UnsupportedEncodingException</span> <span class=\"n\">e</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"n\">Error</span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">);</span> <span class=\"c1\">// impossible</span>\n    <span class=\"o\">}</span> <span class=\"k\">catch</span> <span class=\"o\">(</span><span class=\"n\">IOException</span> <span class=\"n\">e</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"k\">return</span> <span class=\"kc\">null</span><span class=\"o\">;</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</pre></div>\n\n<p>The <code>KEY.decrypt()</code> call will return a <a href=\"http://docs.oracle.com/javase/8/docs/api/javax/crypto/Cipher.html\"><code>javax.crypto.Cipher</code></a>. The Cipher class is handled in <a href=\"https://github.com/jenkinsci/jenkins/blob/93dfe3377ec8d430818f5b9073f16c677343adb4/core/src/main/java/jenkins/security/CryptoConfidentialKey.java\">CryptoConfidentialKey</a> in Jenkins API, where it defines the algorithm used to create the cipher: <a href=\"https://en.wikipedia.org/wiki/Advanced_Encryption_Standard\">AES</a>.</p>\n<p>Jenkins has also a <a href=\"https://github.com/jenkinsci/jenkins/blob/93dfe3377ec8d430818f5b9073f16c677343adb4/core/src/main/java/jenkins/security/ConfidentialStore.java#L63\">ConfidentialStore</a>, that is required to create the cipher. This class must be initialized before someone tries to create or read a cipher. This extra step also increases security, though access to the JVM is still a problem.</p>\n<p>It is a bit late, so it is all for today. In summary: the credentials plug-in gives you a central place to manage credentials, but it is up to plug-in developers to use it. Sensitive values can be encrypted with AES on disk. So it is important that your file permissions, ACL and system auditing processes are in place and well maintained and monitored.</p>\n<p>Happy hacking!</p>"}, "pass_info": {"used_taxonomy_terms": [], "used_pagination": false, "pagination_has_more": false, "used_assets": false, "used_source_names": []}}