---
title: 'Using Active Choices with Role Strategy Plug-in'
author: kinow
tags:
    - jenkins
category: 'blog'
time: '16:05:03'
---

Having worked in Open Source for a few years, one of my favorite things is when you can
share experience with other people that you meet. [Andrew Gray](https://github.com/agray)
has worked with .NET and Jenkins for years, and we met through some Open Source. He also
writes the blog [Jenkins.NET](http://jenkinsheaven.blogspot.co.nz/).

A couple of days ago he had an interesting question about using Active Choices Plug-in
in Jenkins. He wanted to see if that would be possible to use the plug-in to show different
parameters depending on the user permission.

Another important point is that it needed to support the
[Role Strategy Plug-in](https://wiki.jenkins-ci.org/display/JENKINS/Role+Strategy+Plugin). This plug-in
lets you define roles, define which permissions a role has, and then assign users to the roles.

## To the code

{% geshi 'groovy' %}
import hudson.model.User
import hudson.model.Hudson
import hudson.security.AuthorizationStrategy
import hudson.security.Permission
import com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy
import com.michelin.cio.hudson.plugins.rolestrategy.RoleMap

AuthorizationStrategy strategy = Hudson.getInstance().getAuthorizationStrategy();

jobs = []
user = User.current()
userId = user.getId()

if (strategy != null && strategy instanceof com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy) {
    roleStrategy = (RoleBasedAuthorizationStrategy) strategy;
    // not very straightforward to get the groups for a given user
    roles = roleStrategy.getGrantedRoles("globalRoles")
    for (entry in roles) {
        role = entry.key
        users = entry.value
        if (role.getName().equals("tester")) {
            if (userId in users) {
                jobs = ["PROJECT_FOR_TESTERS1", "PROJECT_FOR_TESTERS2"]
                break
            }
        } else if (role.getName().equals("admin")) {
            if (userId in users) {
                jobs = ["PROJECT_FOR_ADMINS1", "PROJECT_FOR_ADMINS2"]
                break
            }
        }
    }
}

return jobs
// TODO: handle anonymous user ;-)
{% endgeshi %}

Let's dissect the code.

{% geshi 'groovy' %}
import hudson.model.User
import hudson.model.Hudson
import hudson.security.AuthorizationStrategy
import hudson.security.Permission
import com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy
import com.michelin.cio.hudson.plugins.rolestrategy.RoleMap
{% endgeshi %}

You start by importing the classes that you need. If you are going to run the code against classes
that may exist only on slaves, you may have to write some more logic to import classes accordingly.

{% geshi 'groovy' %}
AuthorizationStrategy strategy = Hudson.getInstance().getAuthorizationStrategy();

jobs = []
user = User.current()
userId = user.getId()
{% endgeshi %}

The first line gets the current [AuthorizationStrategy](https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/security/AuthorizationStrategy.java)
used in Jenkins.

Then we create an empty array of jobs, which is the value returned by default. And get the current
logged in user ID.

{% geshi 'groovy' %}
if (strategy != null && strategy instanceof com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy) {
    roleStrategy = (RoleBasedAuthorizationStrategy) strategy;
    // not very straightforward to get the groups for a given user
    roles = roleStrategy.getGrantedRoles("globalRoles")
    for (entry in roles) {
        role = entry.key
        users = entry.value
        if (role.getName().equals("tester")) {
            if (userId in users) {
                jobs = ["PROJECT_FOR_TESTERS1", "PROJECT_FOR_TESTERS2"]
                break
            }
        } else if (role.getName().equals("admin")) {
            if (userId in users) {
                jobs = ["PROJECT_FOR_ADMINS1", "PROJECT_FOR_ADMINS2"]
                break
            }
        }
    }
}

return jobs
// TODO: handle anonymous user ;-)
{% endgeshi %}

The final part simply iterates through each existing role, and then through the
users in that role. I could not find a more ellegant way of doing that, but in case
you would like to maybe optimize the code, here are the main classes that I
used from Jenkins to write the script.

* [RoleBasedAuthorizationStrategy.java](https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleBasedAuthorizationStrategy.java)
* [Role.java](https://github.com/jenkinsci/role-strategy-plugin/blob/master/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/Role.java)
* [RoleMap](https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleMap.java)
* [User.java](https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/model/User.java)

## What the code does

In this section we have just simple screenshots, showing the script in the job configuration.

<div class='row'>
<div class="ui container" style='text-align: center;'>
<figure>
<a href="{{assets.screenshot01}}" rel="prettyPhoto" class="thumbnail" title="Screen shot 01">
<img class="ui fluid image" src="{{assets.screenshot01}}" alt="Screen shot 01" />
</a>
<figcaption>Screen shot 01</figcaption>
</figure>
</div>
</div>

And the resulting screen. The parameter **DeployApp** will be available during the build,
and can be used to trigger other jobs or pipelines.

<div class='row'>
<div class="ui container" style='text-align: center;'>
<figure>
<a href="{{assets.screenshot02}}" rel="prettyPhoto" class="thumbnail" title="Screen shot 02">
<img class="ui fluid image" src="{{assets.screenshot02}}" alt="Screen shot 02" />
</a>
<figcaption>Screen shot 02</figcaption>
</figure>
</div>
</div>

## Where can you find this script?

This blog has a copy of the script, but in case you forget the address, I have submitted
a pull request to a [repository](https://github.com/imoutsatsos/jenkins-scriptlets)
maintained by another friend, [Ioannis Moutsatsos](https://github.com/imoutsatsos). Ioannis
maintains a Jenkins installation in Novartis, and is probably the most skillful user
of the Active Choices Plug-in.

Another advantage of this other copy, is that it may be updated with time, in case there are
bugs or improvements. So watch Ioannis' repository for updates!

Happy hacking!

